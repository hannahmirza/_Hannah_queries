SET SEARCH_PATH TO mk_3356_1;

-- ===============================
-- ACCOUNT AGGREGATIONS
-- ===============================


-- ===============================
-- ACCOUNT ATTRIBUTES
-- ===============================


-- ===============================
-- CUSTOMER FIT
-- ===============================


-- ===============================
-- LIKELIHOOD TO BUY
-- ===============================


-- ===============================
-- LEAD GRADE
-- ===============================



  -- The SQL code below was generated using SQLine and the serialized config below
  -- To edit, please update the YAML config and not the SQL code.
  -- The YAML config used to generate this code is serialized.
  -- To deserialize this config, run
  -- node get_config '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'

  -- create a table with contacts and crm_contacts data
DROP TABLE IF EXISTS tmp_lead_grade_audience;
CREATE TEMP TABLE tmp_lead_grade_audience AS
SELECT
      c.id AS contactid,
      c.email,
      cfit_score.customer_fit AS demographics_segment,
      conv_score.likelihood_to_convert_segment AS behavioral_segment,
      cfit_score.logit AS demographics_score,
      conv_score.logit AS behavioral_score
FROM
      contacts AS c
LEFT JOIN
      analysis_scoring_conversion_free_trial AS conv_score
      ON c.contact_id = conv_score.contact_id
LEFT JOIN
      analysis_scoring_customer_fit AS cfit_score
      ON c.id = cfit_score.contactid
;

-- add crm_contacts data into audience table
INSERT INTO tmp_lead_grade_audience
WITH cte_email_behavioral_score AS
(
  SELECT
        c.id AS contactid,
        c.email,
        conv.logit AS behavioral_score,
        conv.likelihood_to_convert_segment AS behavioral_segment,
        ROW_NUMBER() OVER (PARTITION BY c.email ORDER BY conv.logit DESC NULLS LAST) AS rk
  FROM
        analysis_scoring_conversion_free_trial AS conv
  INNER JOIN
        contacts AS c
        ON conv.contact_id = c.contact_id
)
SELECT
      c.id AS contactid,
      c.email,
      cfit_score.customer_fit AS demographics_segment,
      COALESCE(conv_score.behavioral_segment, 'low') AS behavioral_segment,
      cfit_score.logit AS demographics_score,
      COALESCE(conv_score.behavioral_score, 0) AS behavioral_score
FROM
      crm_contacts AS c
LEFT JOIN
      cte_email_behavioral_score AS conv_score
      ON c.email = conv_score.email AND conv_score.rk = 1
LEFT JOIN
      analysis_scoring_customer_fit AS cfit_score
      ON c.id = cfit_score.contactid
;

-- create a lead grade table with no smoothing yet for persons in contacts table
DROP TABLE IF EXISTS tmp_lead_grade;
CREATE TEMP TABLE tmp_lead_grade AS
SELECT
  CASE
    WHEN demographics_segment IS NULL THEN NULL
    WHEN behavioral_segment IN ('high', 'very high', 'already paying')
      AND demographics_segment IN ('good', 'very good')
      THEN 'A'
    WHEN demographics_segment IS NULL THEN NULL
    WHEN behavioral_segment IN ('medium')
      AND demographics_segment IN ('very good')
      THEN 'A'
    WHEN demographics_segment IS NULL THEN NULL
    WHEN behavioral_segment IN ('medium', 'low')
      AND demographics_segment IN ('good', 'very good')
      THEN 'B'
    WHEN demographics_segment IS NULL THEN NULL
    WHEN behavioral_segment IN ('high', 'very high', 'already paying')
      AND demographics_segment IN ('medium')
      THEN 'B'
    WHEN demographics_segment IS NULL THEN NULL
    WHEN behavioral_segment IN ('high', 'very high', 'already paying')
      AND demographics_segment IN ('low')
      THEN 'C'
    WHEN demographics_segment IS NULL THEN NULL
    WHEN behavioral_segment IN ('medium')
      AND demographics_segment IN ('medium')
      THEN 'C'
    WHEN demographics_segment IS NULL THEN NULL
    WHEN behavioral_segment IN ('low')
      AND demographics_segment IN ('medium')
      THEN 'D'
    WHEN demographics_segment IS NULL THEN NULL
    WHEN behavioral_segment IN ('medium')
      AND demographics_segment IN ('low')
      THEN 'D'
    WHEN demographics_segment IS NULL THEN NULL
    WHEN behavioral_segment IN ('low')
      AND demographics_segment IN ('low')
      THEN 'E'
    WHEN demographics_segment IS NULL THEN NULL
    WHEN behavioral_segment IN ('already paying')
      AND demographics_segment IN ('low', 'medium', 'good', 'very good')
      THEN 'C'
    ELSE 'Unexpected value'
  END AS lead_grade,
  *
FROM
  tmp_lead_grade_audience
;

-- create a dataset to create proper scaling/smoothing scores and distribution
-- create a data set of recent signups -> it will be used to evaluate distributions of scores
WITH cte_signups AS
(
  SELECT
        DISTINCT con.email
  FROM
        events AS eve
  INNER JOIN
        contacts AS con
        ON eve.contact_id = con.contact_id
  WHERE
        eve.meta_event = 'signup'
        AND eve.event_timestamp >= DATEADD('day', -30, GETDATE())
),
cte_lead_score AS
(
  SELECT
        (2 * (demographics_score) + 1 * (behavioral_score * 100)) / 3 AS raw_lead_score,
        *
  FROM
        tmp_lead_grade
  WHERE
        email IN (SELECT email FROM cte_signups)
        AND source_system = 'segment'
),
cte_data AS
(
  SELECT
        lead_grade,
        raw_lead_score,
        COUNT(1) AS cnt
  FROM
        cte_lead_score
  GROUP BY
        1, 2
),
-- calculate the cumulative percents within each grade
cte_percentages AS
(
  SELECT
        lead_grade,
        raw_lead_score,
        cnt,
        SUM(cnt) OVER (PARTITION BY lead_grade ORDER BY raw_lead_score DESC ROWS UNBOUNDED PRECEDING) AS cumu_cnt,
        SUM(cnt) OVER (PARTITION BY lead_grade ORDER BY raw_lead_score DESC ROWS UNBOUNDED PRECEDING)::DECIMAL / (SELECT SUM(cnt) FROM cte_data WHERE lead_grade = cte.lead_grade) AS cumu_cnt_percent,
        ROUND(100 - 100 * SUM(cnt) OVER (PARTITION BY lead_grade ORDER BY raw_lead_score DESC ROWS UNBOUNDED PRECEDING)::DECIMAL / (SELECT SUM(cnt) FROM cte_data  WHERE lead_grade = cte.lead_grade)) AS cumu_cnt_percentile
  FROM
        cte_data AS cte
  ORDER BY
        1, 2 DESC
)
-- generate the yaml config to use to map raw scores to a smoothing score between 0 and 100
SELECT
      lead_grade,
      cumu_cnt_percentile,
      MAX(raw_lead_score) AS max_lead_raw_score,
      '- lead_grade: ' + lead_grade + '\n  smoothing_score: ' + cumu_cnt_percentile::TEXT + '\n  raw_lead_score: ' + MAX(raw_lead_score)::TEXT
        + CASE WHEN (FIRST_VALUE(cumu_cnt_percentile) OVER (PARTITION BY lead_grade ORDER BY cumu_cnt_percentile rows unbounded preceding)) = cumu_cnt_percentile THEN '\n  last: true' ELSE '' END
        AS yaml
FROM
      cte_percentages
GROUP BY
      1, 2
ORDER BY
      1 DESC, -- sort in that order to optimize speed in the case statements
      2 DESC
;

-- create the stage table in which we'll insert the scores
-- ===============================
-- Lead Score & Lead Grade (a combination of customer fit and likelihood to buy)
-- ===============================
DROP TABLE IF EXISTS stage_analysis_scoring_lead_grade_testing;
CREATE TABLE stage_analysis_scoring_lead_grade_testing
(
  contactid VARCHAR(256),
  email VARCHAR(256),
  lead_score INT,
  lead_grade VARCHAR(256),
  payload TEXT,
  created_at TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE(),
  updated_at TIMESTAMP WITHOUT TIME ZONE DEFAULT GETDATE()
)
;

-- create a scaled and smoothed score
INSERT INTO stage_analysis_scoring_lead_grade_testing
(
  contactid,
  email,
  lead_score,
  lead_grade,
  payload
)
WITH cte_data AS
(
  SELECT
        (2 * (demographics_score) + 1 * (behavioral_score * 100)) / 3 AS raw_lead_score,
        *
  FROM
        tmp_lead_grade
),
cte_smooth AS
(
  SELECT
        CASE
          WHEN raw_lead_score >= 10 AND lead_grade = 'E' THEN 100
          WHEN raw_lead_score >= 6.333333 AND lead_grade = 'E' THEN 99
          WHEN raw_lead_score >= 1.666666 AND lead_grade = 'E' THEN 98
          WHEN raw_lead_score >= -2.978 AND lead_grade = 'E' THEN 97
          WHEN raw_lead_score >= -3 AND lead_grade = 'E' THEN 94
          WHEN raw_lead_score >= -4.666666 AND lead_grade = 'E' THEN 93
          WHEN raw_lead_score >= -6.333333 AND lead_grade = 'E' THEN 86
          WHEN raw_lead_score >= -7.666666 AND lead_grade = 'E' THEN 85
          WHEN raw_lead_score >= -8.666666 AND lead_grade = 'E' THEN 84
          WHEN raw_lead_score >= -9.666666 AND lead_grade = 'E' THEN 83
          WHEN raw_lead_score >= -11.333333 AND lead_grade = 'E' THEN 81
          WHEN raw_lead_score >= -13 AND lead_grade = 'E' THEN 78
          WHEN raw_lead_score >= -14 AND lead_grade = 'E' THEN 77
          WHEN raw_lead_score >= -18 AND lead_grade = 'E' THEN 76
          WHEN raw_lead_score >= -26.333333 AND lead_grade = 'E' THEN 75
          WHEN raw_lead_score >= -27.666666 AND lead_grade = 'E' THEN 74
          WHEN raw_lead_score >= -29.505666 AND lead_grade = 'E' THEN 73
          WHEN raw_lead_score >= -29.666666 AND lead_grade = 'E' THEN 53
          WHEN raw_lead_score >= -30.666666 AND lead_grade = 'E' THEN 52
          WHEN raw_lead_score >= -31.333333 AND lead_grade = 'E' THEN 51
          WHEN raw_lead_score >= -32.666666 AND lead_grade = 'E' THEN 50
          WHEN raw_lead_score >= -34.666666 AND lead_grade = 'E' THEN 47
          WHEN raw_lead_score >= -36.333333 AND lead_grade = 'E' THEN 46
          WHEN raw_lead_score >= -61.666666 AND lead_grade = 'E' THEN 45
          WHEN raw_lead_score >= -249.666666 AND lead_grade = 'E' THEN 44
          WHEN raw_lead_score >= -260.333333 AND lead_grade = 'E' THEN 43
          WHEN raw_lead_score >= -269.666666 AND lead_grade = 'E' THEN 41
          WHEN raw_lead_score >= -273 AND lead_grade = 'E' THEN 31
          WHEN raw_lead_score >= -273.333333 AND lead_grade = 'E' THEN 30
          WHEN raw_lead_score >= -274.666666 AND lead_grade = 'E' THEN 29
          WHEN raw_lead_score >= -276.333333 AND lead_grade = 'E' THEN 28
          WHEN raw_lead_score >= -278 AND lead_grade = 'E' THEN 27
          WHEN raw_lead_score >= -279.666666 AND lead_grade = 'E' THEN 26
          WHEN raw_lead_score >= -279.996666 AND lead_grade = 'E' THEN 25
          WHEN raw_lead_score >= -294.766666 AND lead_grade = 'E' THEN 24
          WHEN raw_lead_score >= -296.333333 AND lead_grade = 'E' THEN 5
          WHEN raw_lead_score >= -297.666666 AND lead_grade = 'E' THEN 4
          WHEN raw_lead_score >= -299 AND lead_grade = 'E' THEN 3
          WHEN raw_lead_score >= -301.333333 AND lead_grade = 'E' THEN 1
          WHEN raw_lead_score >= -524.333333 AND lead_grade = 'E' THEN 0
          WHEN raw_lead_score < -524.333333 AND lead_grade = 'E' THEN 0
          WHEN raw_lead_score >= 20.583333 AND lead_grade = 'D' THEN 100
          WHEN raw_lead_score >= 15 AND lead_grade = 'D' THEN 99
          WHEN raw_lead_score >= 14.333333 AND lead_grade = 'D' THEN 98
          WHEN raw_lead_score >= 13.666666 AND lead_grade = 'D' THEN 97
          WHEN raw_lead_score >= 13 AND lead_grade = 'D' THEN 96
          WHEN raw_lead_score >= 12.333333 AND lead_grade = 'D' THEN 95
          WHEN raw_lead_score >= 11.666666 AND lead_grade = 'D' THEN 94
          WHEN raw_lead_score >= 11 AND lead_grade = 'D' THEN 93
          WHEN raw_lead_score >= 10.333333 AND lead_grade = 'D' THEN 92
          WHEN raw_lead_score >= 9.666666 AND lead_grade = 'D' THEN 91
          WHEN raw_lead_score >= 9.3 AND lead_grade = 'D' THEN 90
          WHEN raw_lead_score >= 9 AND lead_grade = 'D' THEN 89
          WHEN raw_lead_score >= 7.817666 AND lead_grade = 'D' THEN 88
          WHEN raw_lead_score >= 6.666666 AND lead_grade = 'D' THEN 87
          WHEN raw_lead_score >= 5.733333 AND lead_grade = 'D' THEN 86
          WHEN raw_lead_score >= 5.133333 AND lead_grade = 'D' THEN 85
          WHEN raw_lead_score >= 4 AND lead_grade = 'D' THEN 83
          WHEN raw_lead_score >= 3.666666 AND lead_grade = 'D' THEN 82
          WHEN raw_lead_score >= 3.156 AND lead_grade = 'D' THEN 81
          WHEN raw_lead_score >= 1 AND lead_grade = 'D' THEN 80
          WHEN raw_lead_score >= 0.666666 AND lead_grade = 'D' THEN 78
          WHEN raw_lead_score >= 0.333333 AND lead_grade = 'D' THEN 76
          WHEN raw_lead_score >= 0 AND lead_grade = 'D' THEN 74
          WHEN raw_lead_score >= -2 AND lead_grade = 'D' THEN 73
          WHEN raw_lead_score >= -3.333333 AND lead_grade = 'D' THEN 72
          WHEN raw_lead_score >= -6 AND lead_grade = 'D' THEN 71
          WHEN raw_lead_score >= -6.333333 AND lead_grade = 'D' THEN 70
          WHEN raw_lead_score >= -6.666666 AND lead_grade = 'D' THEN 69
          WHEN raw_lead_score >= -15.233333 AND lead_grade = 'D' THEN 68
          WHEN raw_lead_score >= -17 AND lead_grade = 'D' THEN 67
          WHEN raw_lead_score >= -17.533333 AND lead_grade = 'D' THEN 66
          WHEN raw_lead_score >= -18.033333 AND lead_grade = 'D' THEN 65
          WHEN raw_lead_score >= -18.633333 AND lead_grade = 'D' THEN 64
          WHEN raw_lead_score >= -19.666666 AND lead_grade = 'D' THEN 63
          WHEN raw_lead_score >= -22.133333 AND lead_grade = 'D' THEN 62
          WHEN raw_lead_score >= -22.666666 AND lead_grade = 'D' THEN 55
          WHEN raw_lead_score >= -23 AND lead_grade = 'D' THEN 49
          WHEN raw_lead_score >= -23.333333 AND lead_grade = 'D' THEN 44
          WHEN raw_lead_score >= -26.666666 AND lead_grade = 'D' THEN 43
          WHEN raw_lead_score >= -36.3 AND lead_grade = 'D' THEN 42
          WHEN raw_lead_score >= -218.666666 AND lead_grade = 'D' THEN 41
          WHEN raw_lead_score >= -248 AND lead_grade = 'D' THEN 40
          WHEN raw_lead_score >= -258.479333 AND lead_grade = 'D' THEN 39
          WHEN raw_lead_score >= -260.666666 AND lead_grade = 'D' THEN 38
          WHEN raw_lead_score >= -261.6 AND lead_grade = 'D' THEN 37
          WHEN raw_lead_score >= -263 AND lead_grade = 'D' THEN 36
          WHEN raw_lead_score >= -265.666666 AND lead_grade = 'D' THEN 35
          WHEN raw_lead_score >= -266 AND lead_grade = 'D' THEN 32
          WHEN raw_lead_score >= -266.333333 AND lead_grade = 'D' THEN 29
          WHEN raw_lead_score >= -266.666666 AND lead_grade = 'D' THEN 27
          WHEN raw_lead_score >= -268.666666 AND lead_grade = 'D' THEN 26
          WHEN raw_lead_score >= -273.333333 AND lead_grade = 'D' THEN 25
          WHEN raw_lead_score >= -283.384 AND lead_grade = 'D' THEN 24
          WHEN raw_lead_score >= -284.533333 AND lead_grade = 'D' THEN 23
          WHEN raw_lead_score >= -285.166666 AND lead_grade = 'D' THEN 22
          WHEN raw_lead_score >= -288.466666 AND lead_grade = 'D' THEN 21
          WHEN raw_lead_score >= -289 AND lead_grade = 'D' THEN 20
          WHEN raw_lead_score >= -289.333333 AND lead_grade = 'D' THEN 13
          WHEN raw_lead_score >= -289.666666 AND lead_grade = 'D' THEN 6
          WHEN raw_lead_score >= -290 AND lead_grade = 'D' THEN 1
          WHEN raw_lead_score >= -510.666666 AND lead_grade = 'D' THEN 0
          WHEN raw_lead_score < -510.666666 AND lead_grade = 'D' THEN 0
          WHEN raw_lead_score >= 51 AND lead_grade = 'C' THEN 100
          WHEN raw_lead_score >= 42.008333 AND lead_grade = 'C' THEN 99
          WHEN raw_lead_score >= 25.647666 AND lead_grade = 'C' THEN 98
          WHEN raw_lead_score >= 21.766666 AND lead_grade = 'C' THEN 97
          WHEN raw_lead_score >= 21.166666 AND lead_grade = 'C' THEN 96
          WHEN raw_lead_score >= 20 AND lead_grade = 'C' THEN 95
          WHEN raw_lead_score >= 19.120333 AND lead_grade = 'C' THEN 94
          WHEN raw_lead_score >= 18.333333 AND lead_grade = 'C' THEN 93
          WHEN raw_lead_score >= 17.666666 AND lead_grade = 'C' THEN 92
          WHEN raw_lead_score >= 17 AND lead_grade = 'C' THEN 91
          WHEN raw_lead_score >= 15.735 AND lead_grade = 'C' THEN 90
          WHEN raw_lead_score >= 14.658333 AND lead_grade = 'C' THEN 89
          WHEN raw_lead_score >= 13.666666 AND lead_grade = 'C' THEN 88
          WHEN raw_lead_score >= 12.153333 AND lead_grade = 'C' THEN 87
          WHEN raw_lead_score >= 11.133333 AND lead_grade = 'C' THEN 86
          WHEN raw_lead_score >= 9.433333 AND lead_grade = 'C' THEN 85
          WHEN raw_lead_score >= 8.508333 AND lead_grade = 'C' THEN 84
          WHEN raw_lead_score >= 8.156666 AND lead_grade = 'C' THEN 83
          WHEN raw_lead_score >= 7.333333 AND lead_grade = 'C' THEN 82
          WHEN raw_lead_score >= 6.294666 AND lead_grade = 'C' THEN 81
          WHEN raw_lead_score >= 5.335 AND lead_grade = 'C' THEN 80
          WHEN raw_lead_score >= 5.071666 AND lead_grade = 'C' THEN 79
          WHEN raw_lead_score >= 4.816 AND lead_grade = 'C' THEN 78
          WHEN raw_lead_score >= 4.435 AND lead_grade = 'C' THEN 77
          WHEN raw_lead_score >= 4.036666 AND lead_grade = 'C' THEN 76
          WHEN raw_lead_score >= 2.313333 AND lead_grade = 'C' THEN 75
          WHEN raw_lead_score >= 1.218333 AND lead_grade = 'C' THEN 74
          WHEN raw_lead_score >= -1.158333 AND lead_grade = 'C' THEN 73
          WHEN raw_lead_score >= -1.841666 AND lead_grade = 'C' THEN 72
          WHEN raw_lead_score >= -2.55 AND lead_grade = 'C' THEN 71
          WHEN raw_lead_score >= -6.333333 AND lead_grade = 'C' THEN 70
          WHEN raw_lead_score >= -9.531333 AND lead_grade = 'C' THEN 69
          WHEN raw_lead_score >= -9.666666 AND lead_grade = 'C' THEN 67
          WHEN raw_lead_score >= -11.633333 AND lead_grade = 'C' THEN 66
          WHEN raw_lead_score >= -12.700666 AND lead_grade = 'C' THEN 65
          WHEN raw_lead_score >= -13.714333 AND lead_grade = 'C' THEN 64
          WHEN raw_lead_score >= -14.566666 AND lead_grade = 'C' THEN 63
          WHEN raw_lead_score >= -15.033333 AND lead_grade = 'C' THEN 62
          WHEN raw_lead_score >= -15.466666 AND lead_grade = 'C' THEN 61
          WHEN raw_lead_score >= -15.884333 AND lead_grade = 'C' THEN 60
          WHEN raw_lead_score >= -16.816333 AND lead_grade = 'C' THEN 59
          WHEN raw_lead_score >= -17.497333 AND lead_grade = 'C' THEN 58
          WHEN raw_lead_score >= -17.889666 AND lead_grade = 'C' THEN 57
          WHEN raw_lead_score >= -18.07 AND lead_grade = 'C' THEN 56
          WHEN raw_lead_score >= -18.178333 AND lead_grade = 'C' THEN 55
          WHEN raw_lead_score >= -18.268333 AND lead_grade = 'C' THEN 54
          WHEN raw_lead_score >= -18.341666 AND lead_grade = 'C' THEN 53
          WHEN raw_lead_score >= -18.548333 AND lead_grade = 'C' THEN 52
          WHEN raw_lead_score >= -18.633333 AND lead_grade = 'C' THEN 51
          WHEN raw_lead_score >= -18.846666 AND lead_grade = 'C' THEN 50
          WHEN raw_lead_score >= -19.156666 AND lead_grade = 'C' THEN 49
          WHEN raw_lead_score >= -21.6 AND lead_grade = 'C' THEN 48
          WHEN raw_lead_score >= -25.144 AND lead_grade = 'C' THEN 47
          WHEN raw_lead_score >= -107 AND lead_grade = 'C' THEN 46
          WHEN raw_lead_score >= -230.265 AND lead_grade = 'C' THEN 45
          WHEN raw_lead_score >= -238.333333 AND lead_grade = 'C' THEN 44
          WHEN raw_lead_score >= -241.333333 AND lead_grade = 'C' THEN 43
          WHEN raw_lead_score >= -244.07 AND lead_grade = 'C' THEN 42
          WHEN raw_lead_score >= -247 AND lead_grade = 'C' THEN 41
          WHEN raw_lead_score >= -249.666666 AND lead_grade = 'C' THEN 40
          WHEN raw_lead_score >= -251.6 AND lead_grade = 'C' THEN 39
          WHEN raw_lead_score >= -252 AND lead_grade = 'C' THEN 38
          WHEN raw_lead_score >= -253 AND lead_grade = 'C' THEN 36
          WHEN raw_lead_score >= -254.255666 AND lead_grade = 'C' THEN 35
          WHEN raw_lead_score >= -255.618 AND lead_grade = 'C' THEN 34
          WHEN raw_lead_score >= -256 AND lead_grade = 'C' THEN 33
          WHEN raw_lead_score >= -256.733333 AND lead_grade = 'C' THEN 32
          WHEN raw_lead_score >= -257.138333 AND lead_grade = 'C' THEN 31
          WHEN raw_lead_score >= -257.801666 AND lead_grade = 'C' THEN 30
          WHEN raw_lead_score >= -258.535 AND lead_grade = 'C' THEN 29
          WHEN raw_lead_score >= -259.266666 AND lead_grade = 'C' THEN 28
          WHEN raw_lead_score >= -260.333333 AND lead_grade = 'C' THEN 27
          WHEN raw_lead_score >= -261.12 AND lead_grade = 'C' THEN 26
          WHEN raw_lead_score >= -261.39 AND lead_grade = 'C' THEN 25
          WHEN raw_lead_score >= -261.516666 AND lead_grade = 'C' THEN 24
          WHEN raw_lead_score >= -261.843333 AND lead_grade = 'C' THEN 23
          WHEN raw_lead_score >= -262.066666 AND lead_grade = 'C' THEN 22
          WHEN raw_lead_score >= -262.546666 AND lead_grade = 'C' THEN 21
          WHEN raw_lead_score >= -266.64 AND lead_grade = 'C' THEN 20
          WHEN raw_lead_score >= -274.633666 AND lead_grade = 'C' THEN 19
          WHEN raw_lead_score >= -276.333333 AND lead_grade = 'C' THEN 18
          WHEN raw_lead_score >= -278.333333 AND lead_grade = 'C' THEN 17
          WHEN raw_lead_score >= -280.4 AND lead_grade = 'C' THEN 16
          WHEN raw_lead_score >= -281.693333 AND lead_grade = 'C' THEN 15
          WHEN raw_lead_score >= -282.633333 AND lead_grade = 'C' THEN 14
          WHEN raw_lead_score >= -284.305 AND lead_grade = 'C' THEN 13
          WHEN raw_lead_score >= -284.648333 AND lead_grade = 'C' THEN 12
          WHEN raw_lead_score >= -284.868333 AND lead_grade = 'C' THEN 11
          WHEN raw_lead_score >= -285.14 AND lead_grade = 'C' THEN 10
          WHEN raw_lead_score >= -285.465 AND lead_grade = 'C' THEN 9
          WHEN raw_lead_score >= -285.963333 AND lead_grade = 'C' THEN 8
          WHEN raw_lead_score >= -507.216666 AND lead_grade = 'C' THEN 7
          WHEN raw_lead_score >= -511.6 AND lead_grade = 'C' THEN 6
          WHEN raw_lead_score >= -514.333333 AND lead_grade = 'C' THEN 5
          WHEN raw_lead_score >= -518.333333 AND lead_grade = 'C' THEN 4
          WHEN raw_lead_score >= -518.666666 AND lead_grade = 'C' THEN 3
          WHEN raw_lead_score >= -522.333333 AND lead_grade = 'C' THEN 2
          WHEN raw_lead_score >= -523.666666 AND lead_grade = 'C' THEN 1
          WHEN raw_lead_score >= -527.333333 AND lead_grade = 'C' THEN 0
          WHEN raw_lead_score < -527.333333 AND lead_grade = 'C' THEN 0
          WHEN raw_lead_score >= 54.666666 AND lead_grade = 'B' THEN 100
          WHEN raw_lead_score >= 47 AND lead_grade = 'B' THEN 99
          WHEN raw_lead_score >= 44.666666 AND lead_grade = 'B' THEN 98
          WHEN raw_lead_score >= 43 AND lead_grade = 'B' THEN 97
          WHEN raw_lead_score >= 41 AND lead_grade = 'B' THEN 96
          WHEN raw_lead_score >= 39.678666 AND lead_grade = 'B' THEN 95
          WHEN raw_lead_score >= 39 AND lead_grade = 'B' THEN 94
          WHEN raw_lead_score >= 38.333333 AND lead_grade = 'B' THEN 93
          WHEN raw_lead_score >= 37.666666 AND lead_grade = 'B' THEN 92
          WHEN raw_lead_score >= 37 AND lead_grade = 'B' THEN 91
          WHEN raw_lead_score >= 36.333333 AND lead_grade = 'B' THEN 90
          WHEN raw_lead_score >= 35.666666 AND lead_grade = 'B' THEN 88
          WHEN raw_lead_score >= 34.86 AND lead_grade = 'B' THEN 87
          WHEN raw_lead_score >= 34 AND lead_grade = 'B' THEN 86
          WHEN raw_lead_score >= 33.666666 AND lead_grade = 'B' THEN 85
          WHEN raw_lead_score >= 33 AND lead_grade = 'B' THEN 84
          WHEN raw_lead_score >= 32.666666 AND lead_grade = 'B' THEN 83
          WHEN raw_lead_score >= 32.333333 AND lead_grade = 'B' THEN 81
          WHEN raw_lead_score >= 31.9 AND lead_grade = 'B' THEN 80
          WHEN raw_lead_score >= 31.666666 AND lead_grade = 'B' THEN 79
          WHEN raw_lead_score >= 31.366666 AND lead_grade = 'B' THEN 78
          WHEN raw_lead_score >= 31 AND lead_grade = 'B' THEN 77
          WHEN raw_lead_score >= 30.666666 AND lead_grade = 'B' THEN 76
          WHEN raw_lead_score >= 30.333333 AND lead_grade = 'B' THEN 75
          WHEN raw_lead_score >= 30 AND lead_grade = 'B' THEN 74
          WHEN raw_lead_score >= 29.666666 AND lead_grade = 'B' THEN 73
          WHEN raw_lead_score >= 29.333333 AND lead_grade = 'B' THEN 72
          WHEN raw_lead_score >= 29 AND lead_grade = 'B' THEN 70
          WHEN raw_lead_score >= 28.456333 AND lead_grade = 'B' THEN 69
          WHEN raw_lead_score >= 28.333333 AND lead_grade = 'B' THEN 68
          WHEN raw_lead_score >= 28 AND lead_grade = 'B' THEN 67
          WHEN raw_lead_score >= 27.666666 AND lead_grade = 'B' THEN 66
          WHEN raw_lead_score >= 27.476666 AND lead_grade = 'B' THEN 65
          WHEN raw_lead_score >= 27.333333 AND lead_grade = 'B' THEN 64
          WHEN raw_lead_score >= 27 AND lead_grade = 'B' THEN 62
          WHEN raw_lead_score >= 26.666666 AND lead_grade = 'B' THEN 61
          WHEN raw_lead_score >= 26.333333 AND lead_grade = 'B' THEN 60
          WHEN raw_lead_score >= 26.033333 AND lead_grade = 'B' THEN 59
          WHEN raw_lead_score >= 25.85 AND lead_grade = 'B' THEN 58
          WHEN raw_lead_score >= 25.666666 AND lead_grade = 'B' THEN 57
          WHEN raw_lead_score >= 25.333333 AND lead_grade = 'B' THEN 55
          WHEN raw_lead_score >= 25 AND lead_grade = 'B' THEN 53
          WHEN raw_lead_score >= 24.666666 AND lead_grade = 'B' THEN 52
          WHEN raw_lead_score >= 24.333333 AND lead_grade = 'B' THEN 50
          WHEN raw_lead_score >= 24 AND lead_grade = 'B' THEN 49
          WHEN raw_lead_score >= 23.79 AND lead_grade = 'B' THEN 48
          WHEN raw_lead_score >= 23.666666 AND lead_grade = 'B' THEN 47
          WHEN raw_lead_score >= 23.333333 AND lead_grade = 'B' THEN 45
          WHEN raw_lead_score >= 23 AND lead_grade = 'B' THEN 43
          WHEN raw_lead_score >= 22.666666 AND lead_grade = 'B' THEN 42
          WHEN raw_lead_score >= 22.498333 AND lead_grade = 'B' THEN 41
          WHEN raw_lead_score >= 22.333333 AND lead_grade = 'B' THEN 39
          WHEN raw_lead_score >= 22.055 AND lead_grade = 'B' THEN 38
          WHEN raw_lead_score >= 21.666666 AND lead_grade = 'B' THEN 35
          WHEN raw_lead_score >= 21 AND lead_grade = 'B' THEN 33
          WHEN raw_lead_score >= 20.666666 AND lead_grade = 'B' THEN 32
          WHEN raw_lead_score >= 20.333333 AND lead_grade = 'B' THEN 31
          WHEN raw_lead_score >= 20.181666 AND lead_grade = 'B' THEN 30
          WHEN raw_lead_score >= 19.666666 AND lead_grade = 'B' THEN 28
          WHEN raw_lead_score >= 19 AND lead_grade = 'B' THEN 27
          WHEN raw_lead_score >= 18.333333 AND lead_grade = 'B' THEN 26
          WHEN raw_lead_score >= 18 AND lead_grade = 'B' THEN 25
          WHEN raw_lead_score >= 17.666666 AND lead_grade = 'B' THEN 24
          WHEN raw_lead_score >= 17.333333 AND lead_grade = 'B' THEN 23
          WHEN raw_lead_score >= 17 AND lead_grade = 'B' THEN 22
          WHEN raw_lead_score >= 16.666666 AND lead_grade = 'B' THEN 21
          WHEN raw_lead_score >= 16.333333 AND lead_grade = 'B' THEN 20
          WHEN raw_lead_score >= 15.957666 AND lead_grade = 'B' THEN 19
          WHEN raw_lead_score >= 15.666666 AND lead_grade = 'B' THEN 18
          WHEN raw_lead_score >= 15.333333 AND lead_grade = 'B' THEN 17
          WHEN raw_lead_score >= 15 AND lead_grade = 'B' THEN 15
          WHEN raw_lead_score >= 14.333333 AND lead_grade = 'B' THEN 14
          WHEN raw_lead_score >= 13.333333 AND lead_grade = 'B' THEN 13
          WHEN raw_lead_score >= 12 AND lead_grade = 'B' THEN 12
          WHEN raw_lead_score >= 11.333333 AND lead_grade = 'B' THEN 10
          WHEN raw_lead_score >= 10 AND lead_grade = 'B' THEN 0
          WHEN raw_lead_score < 10 AND lead_grade = 'B' THEN 0
          WHEN raw_lead_score >= 71.5 AND lead_grade = 'A' THEN 100
          WHEN raw_lead_score >= 66.333333 AND lead_grade = 'A' THEN 99
          WHEN raw_lead_score >= 62 AND lead_grade = 'A' THEN 98
          WHEN raw_lead_score >= 59.5 AND lead_grade = 'A' THEN 97
          WHEN raw_lead_score >= 57.488333 AND lead_grade = 'A' THEN 96
          WHEN raw_lead_score >= 56.2 AND lead_grade = 'A' THEN 95
          WHEN raw_lead_score >= 55 AND lead_grade = 'A' THEN 94
          WHEN raw_lead_score >= 53.671 AND lead_grade = 'A' THEN 93
          WHEN raw_lead_score >= 53 AND lead_grade = 'A' THEN 92
          WHEN raw_lead_score >= 52.215 AND lead_grade = 'A' THEN 91
          WHEN raw_lead_score >= 51.526 AND lead_grade = 'A' THEN 90
          WHEN raw_lead_score >= 51 AND lead_grade = 'A' THEN 89
          WHEN raw_lead_score >= 49.997 AND lead_grade = 'A' THEN 88
          WHEN raw_lead_score >= 49.766666 AND lead_grade = 'A' THEN 87
          WHEN raw_lead_score >= 49.418333 AND lead_grade = 'A' THEN 86
          WHEN raw_lead_score >= 48.921666 AND lead_grade = 'A' THEN 85
          WHEN raw_lead_score >= 48.333333 AND lead_grade = 'A' THEN 84
          WHEN raw_lead_score >= 47.666666 AND lead_grade = 'A' THEN 83
          WHEN raw_lead_score >= 47.333333 AND lead_grade = 'A' THEN 82
          WHEN raw_lead_score >= 46.733333 AND lead_grade = 'A' THEN 81
          WHEN raw_lead_score >= 46.495 AND lead_grade = 'A' THEN 80
          WHEN raw_lead_score >= 46 AND lead_grade = 'A' THEN 79
          WHEN raw_lead_score >= 45.666666 AND lead_grade = 'A' THEN 78
          WHEN raw_lead_score >= 45.333333 AND lead_grade = 'A' THEN 77
          WHEN raw_lead_score >= 45 AND lead_grade = 'A' THEN 76
          WHEN raw_lead_score >= 44.666666 AND lead_grade = 'A' THEN 75
          WHEN raw_lead_score >= 44.333333 AND lead_grade = 'A' THEN 74
          WHEN raw_lead_score >= 44 AND lead_grade = 'A' THEN 73
          WHEN raw_lead_score >= 43.666666 AND lead_grade = 'A' THEN 72
          WHEN raw_lead_score >= 43.333333 AND lead_grade = 'A' THEN 71
          WHEN raw_lead_score >= 43 AND lead_grade = 'A' THEN 70
          WHEN raw_lead_score >= 42.675 AND lead_grade = 'A' THEN 69
          WHEN raw_lead_score >= 42.333333 AND lead_grade = 'A' THEN 67
          WHEN raw_lead_score >= 42 AND lead_grade = 'A' THEN 66
          WHEN raw_lead_score >= 41.766666 AND lead_grade = 'A' THEN 65
          WHEN raw_lead_score >= 41.666666 AND lead_grade = 'A' THEN 64
          WHEN raw_lead_score >= 41.216666 AND lead_grade = 'A' THEN 63
          WHEN raw_lead_score >= 41 AND lead_grade = 'A' THEN 62
          WHEN raw_lead_score >= 40.856666 AND lead_grade = 'A' THEN 61
          WHEN raw_lead_score >= 40.666666 AND lead_grade = 'A' THEN 60
          WHEN raw_lead_score >= 40.560333 AND lead_grade = 'A' THEN 59
          WHEN raw_lead_score >= 40.133333 AND lead_grade = 'A' THEN 58
          WHEN raw_lead_score >= 39.9 AND lead_grade = 'A' THEN 57
          WHEN raw_lead_score >= 39.666666 AND lead_grade = 'A' THEN 56
          WHEN raw_lead_score >= 39.333333 AND lead_grade = 'A' THEN 55
          WHEN raw_lead_score >= 39 AND lead_grade = 'A' THEN 54
          WHEN raw_lead_score >= 38.75 AND lead_grade = 'A' THEN 53
          WHEN raw_lead_score >= 38.666666 AND lead_grade = 'A' THEN 51
          WHEN raw_lead_score >= 38.465 AND lead_grade = 'A' THEN 50
          WHEN raw_lead_score >= 38.333333 AND lead_grade = 'A' THEN 49
          WHEN raw_lead_score >= 38.1 AND lead_grade = 'A' THEN 48
          WHEN raw_lead_score >= 37.666666 AND lead_grade = 'A' THEN 46
          WHEN raw_lead_score >= 37.333333 AND lead_grade = 'A' THEN 44
          WHEN raw_lead_score >= 36.933333 AND lead_grade = 'A' THEN 43
          WHEN raw_lead_score >= 36.6 AND lead_grade = 'A' THEN 42
          WHEN raw_lead_score >= 36.333333 AND lead_grade = 'A' THEN 41
          WHEN raw_lead_score >= 36.23 AND lead_grade = 'A' THEN 40
          WHEN raw_lead_score >= 36 AND lead_grade = 'A' THEN 39
          WHEN raw_lead_score >= 35.493333 AND lead_grade = 'A' THEN 38
          WHEN raw_lead_score >= 35.231666 AND lead_grade = 'A' THEN 37
          WHEN raw_lead_score >= 35 AND lead_grade = 'A' THEN 36
          WHEN raw_lead_score >= 34.666666 AND lead_grade = 'A' THEN 35
          WHEN raw_lead_score >= 34.444333 AND lead_grade = 'A' THEN 34
          WHEN raw_lead_score >= 34.333333 AND lead_grade = 'A' THEN 33
          WHEN raw_lead_score >= 34 AND lead_grade = 'A' THEN 32
          WHEN raw_lead_score >= 33.76 AND lead_grade = 'A' THEN 31
          WHEN raw_lead_score >= 33.666666 AND lead_grade = 'A' THEN 28
          WHEN raw_lead_score >= 33 AND lead_grade = 'A' THEN 26
          WHEN raw_lead_score >= 32.666666 AND lead_grade = 'A' THEN 25
          WHEN raw_lead_score >= 32.396333 AND lead_grade = 'A' THEN 24
          WHEN raw_lead_score >= 32.333333 AND lead_grade = 'A' THEN 23
          WHEN raw_lead_score >= 31.7 AND lead_grade = 'A' THEN 22
          WHEN raw_lead_score >= 31.552 AND lead_grade = 'A' THEN 21
          WHEN raw_lead_score >= 31.166666 AND lead_grade = 'A' THEN 20
          WHEN raw_lead_score >= 30.735 AND lead_grade = 'A' THEN 19
          WHEN raw_lead_score >= 30.625 AND lead_grade = 'A' THEN 18
          WHEN raw_lead_score >= 29.826666 AND lead_grade = 'A' THEN 17
          WHEN raw_lead_score >= 29.608333 AND lead_grade = 'A' THEN 16
          WHEN raw_lead_score >= 29 AND lead_grade = 'A' THEN 15
          WHEN raw_lead_score >= 28.666666 AND lead_grade = 'A' THEN 14
          WHEN raw_lead_score >= 27.666666 AND lead_grade = 'A' THEN 12
          WHEN raw_lead_score >= 27.044333 AND lead_grade = 'A' THEN 11
          WHEN raw_lead_score >= 26.761666 AND lead_grade = 'A' THEN 10
          WHEN raw_lead_score >= 26.396666 AND lead_grade = 'A' THEN 9
          WHEN raw_lead_score >= 25.666666 AND lead_grade = 'A' THEN 7
          WHEN raw_lead_score >= 24 AND lead_grade = 'A' THEN 6
          WHEN raw_lead_score >= 22.666666 AND lead_grade = 'A' THEN 5
          WHEN raw_lead_score >= 20.333333 AND lead_grade = 'A' THEN 4
          WHEN raw_lead_score >= 19.333333 AND lead_grade = 'A' THEN 3
          WHEN raw_lead_score >= 18.333333 AND lead_grade = 'A' THEN 2
          WHEN raw_lead_score >= 15.666666 AND lead_grade = 'A' THEN 1
          WHEN raw_lead_score >= 14.333333 AND lead_grade = 'A' THEN 0
          WHEN raw_lead_score < 14.333333 AND lead_grade = 'A' THEN 0
        END AS smoothing_score,
        *
  FROM
        cte_data
)
SELECT
      contactid,
      email,
      CASE
        WHEN lead_grade = 'A' THEN ROUND(90 + (100-90) * smoothing_score::DECIMAL / 100)
        WHEN lead_grade = 'B' THEN ROUND(75 + (89-75) * smoothing_score::DECIMAL / 100)
        WHEN lead_grade = 'C' THEN ROUND(50 + (74-50) * smoothing_score::DECIMAL / 100)
        WHEN lead_grade = 'D' THEN ROUND(25 + (50-25) * smoothing_score::DECIMAL / 100)
        WHEN lead_grade = 'E' THEN ROUND(1 + (24-1) * smoothing_score::DECIMAL / 100)
      END AS lead_score,
      lead_grade,
      '{ '||
      'customer_fit:' + demographics_segment + ',' ||
      'likelihood_to_convert_segment:' + behavioral_segment + ',' ||
      'likelihood_to_convert_logit:' +
      (
        CASE
          WHEN lead_grade = 'A' THEN ROUND(90 + (100-90) * smoothing_score::DECIMAL / 100)
          WHEN lead_grade = 'B' THEN ROUND(75 + (89-75) * smoothing_score::DECIMAL / 100)
          WHEN lead_grade = 'C' THEN ROUND(50 + (74-50) * smoothing_score::DECIMAL / 100)
          WHEN lead_grade = 'D' THEN ROUND(25 + (50-25) * smoothing_score::DECIMAL / 100)
          WHEN lead_grade = 'E' THEN ROUND(1 + (24-1) * smoothing_score::DECIMAL / 100)
        END
      )::TEXT
       + '' ||
      '}'::TEXT AS payload
FROM
      cte_smooth
;

-- swap stage table and live table
DROP TABLE IF EXISTS analysis_scoring_lead_grade_testing;
ALTER TABLE stage_analysis_scoring_lead_grade_testing RENAME TO analysis_scoring_lead_grade_testing
;

-- ===============================
-- CONVERSION RATES
-- ===============================

-- ======================== Parameters ========================
--  Define your audience
DROP TABLE IF EXISTS tmp_audience;
CREATE TEMP TABLE tmp_audience AS
SELECT
  c.contact_id,
  c.a_hs_analytics_source,
  c.email,
  c.source_key_value,
  c.created_date
FROM
  contacts AS c
WHERE
  c.source_system = 'hubspot'
  AND
  created_date >= GETDATE() - 30
--   AND created_date >= '2018-01-01'
--   AND created_date < '2018-04-01'
;

-- Define the target metric
DROP TABLE IF EXISTS tmp_target;
CREATE TEMP TABLE tmp_target AS
SELECT
  c.contact_id,
  c.email,
  a_first_deal_created_date,
  a_recent_deal_close_date,
  a_recent_deal_amount
FROM
  contacts c
WHERE
  c.source_system = 'hubspot'
  AND
  (
    a_first_deal_created_date IS NOT NULL
    OR
    a_hs_lead_status = 'Deal Won'
    OR a_hs_lead_status = 'Open Deal' )
;


-- ======================== High Level Customer Fit Model Performance ========================
SELECT
      customer_fit,
      count(DISTINCT CASE WHEN a.contact_id IS NOT NULL THEN c.email ELSE NULL END) AS "Conversion",
      count(distinct c.email) AS "Population",
      100.0 * count(DISTINCT CASE WHEN a.contact_id IS NOT NULL THEN c.email ELSE NULL END) / count(distinct c.email) AS "Conversion Rate"
FROM
      tmp_audience AS c
INNER JOIN
      analysis_scoring_customer_fit AS af
      ON LOWER(c.source_key_value) = LOWER(af.source_key_value)
LEFT JOIN
    tmp_target AS a
    ON c.contact_id = a.contact_id
GROUP BY
  1
ORDER BY
  CASE customer_fit
    WHEN 'very good' THEN 1
    WHEN 'good' THEN 2
    WHEN 'medium' THEN 3
    WHEN 'low' THEN 4
    WHEN 'already paying' THEN 5
    ELSE 6
  END DESC


-- ======================== High Level Likelihood to Buy  Model Performance ========================
SELECT
      likelihood_to_convert_segment AS source,
      count(DISTINCT CASE WHEN a.contact_id IS NOT NULL THEN c.email ELSE NULL END) AS "Conversion",
      count(distinct c.email) AS "Population",
      100.0 * count(DISTINCT CASE WHEN a.contact_id IS NOT NULL THEN c.email ELSE NULL END) / count(distinct c.email) AS "Conversion Rate"
FROM
      tmp_audience AS c
INNER JOIN
      analysis_scoring_conversion_free_trial AS af
      ON LOWER(c.contact_id) = LOWER(af.contact_id)
LEFT JOIN
    tmp_target AS a
    ON c.contact_id = a.contact_id
LEFT JOIN
    events e
    ON c.contact_id = e.contact_id
GROUP BY
  1
ORDER BY
  CASE likelihood_to_convert_segment
    WHEN 'very high' THEN 1
    WHEN 'high' THEN 2
    WHEN 'medium' THEN 3
    WHEN 'low' THEN 4
    WHEN 'already paying' THEN 5
    ELSE 6
  END DESC
;



